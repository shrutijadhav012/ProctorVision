<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProctorVision AI</title>
  <style>
    
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;line-height:1.4;background:#0f172a;color:#e6eef8;min-height:100vh}
    .container{max-width:1100px;margin:28px auto;padding:24px}

   
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{font-weight:700;font-size:20px}
    nav a{color:inherit;margin-left:12px;text-decoration:none;opacity:.85}

    
    .page{display:none;animation:fade .45s ease both}
    .active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    
    .welcome{display:flex;flex-direction:column;gap:18px;align-items:center;justify-content:center;height:70vh;text-align:center}
    .hero{font-size:44px;font-weight:800;letter-spacing:-1px}
    .sub{font-size:16px;opacity:.9}

   
    .animated-gradient{
      background:linear-gradient(90deg,#7c3aed,#06b6d4,#f97316,#ef4444,#7c3aed);
      background-size:200% 200%;
      -webkit-background-clip:text;background-clip:text;color:transparent;
      animation:slidebg 6s linear infinite;
      padding:8px 12px;border-radius:8px
    }
    @keyframes slidebg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .cta{margin-top:8px}
    .btn{background:#111827;color:#fff;padding:12px 18px;border-radius:10px;border:1px solid rgba(255,255,255,.06);cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.08)}

    
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    form{display:flex;flex-direction:column;gap:12px}
    label{font-size:13px;color:#a6b0c6}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:12px}
    .row .col{flex:1}
    .muted{font-size:13px;color:#9aa7c7}

    
    .invalid{border-color:#ef4444}
    .valid{border-color:#10b981}
    .feedback{font-size:13px}
    .feedback.error{color:#ff7b7b}
    .feedback.ok{color:#7ef3b6}

    
    .webcam-wrap{display:flex;gap:16px;flex-wrap:wrap}
    video#preview{width:420px;height:315px;border-radius:8px;background:#020617;object-fit:cover}
    canvas#capture{display:none}
    .controls{display:flex;flex-direction:column;gap:8px}

    
    .exam-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .timer{font-weight:700;font-size:18px}
    .camera-mini{width:200px;height:150px;border-radius:8px;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
    .question-area{margin-top:16px}
    .qcard{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-bottom:12px}
    .qnav{display:flex;gap:6px;flex-wrap:wrap}
    .qnav button{padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);cursor:pointer}

    
    .floating-camera{position:fixed;top:18px;right:18px;width:188px;height:120px;border-radius:10px;overflow:hidden;border:3px solid rgba(255,255,255,0.06);z-index:999;background:#000;transition:border-color 0.3s}
    .floating-camera.alert{border:3px solid #ef4444;box-shadow:0 0 20px rgba(239,68,68,0.5)}
    .floating-camera.warning{border:3px solid #f97316;box-shadow:0 0 15px rgba(249,115,22,0.4)}
    .floating-camera.good{border:3px solid #10b981;box-shadow:0 0 10px rgba(16,185,129,0.3)}
    .status-pill{padding:6px 10px;border-radius:999px;font-size:13px}
    .status-green{background:#04260f;color:#86efac}
    .status-red{background:#2a0b0b;color:#ffb4b4}

    
    .warnings{position:fixed;left:18px;bottom:18px;max-width:380px}
    .warn{background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;margin-top:8px}
    .warn .title{font-weight:700}
    .warn.red{border-left:6px solid #ef4444}
    .warn.green{border-left:6px solid #10b981}

   
    @media(max-width:880px){.hero{font-size:32px}.webcam-wrap{flex-direction:column}video#preview{width:100%;height:auto}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">ProctorVision AI</div>
      <nav>
        <a href="#" id="nav-welcome">Welcome</a>
        <a href="#" id="nav-auth">Register / Login</a>
        <a href="#" id="nav-face">Face Register</a>
        <a href="#" id="nav-exam">Exam</a>
      </nav>
    </header>

    
    <main id="welcome" class="page active">
      <section class="welcome card">
        <div class="hero animated-gradient">Welcome to ProctorVision AI</div>
        <div class="sub">Secure, simple online proctoring tailored for handwritten tests.</div>
        <div style="margin: 20px 0; font-size: 14px; color: #a6b0c6; text-align: left; max-width: 500px;">
          <h4 style="color: #e6eef8; margin-bottom: 10px;">üìã How it works:</h4>
          <div>1Ô∏è‚É£ <strong>Register</strong> - Create your account</div>
          <div>2Ô∏è‚É£ <strong>Login</strong> - Access your account</div>  
          <div>3Ô∏è‚É£ <strong>Face Setup</strong> - Register your face for verification</div>
          <div>4Ô∏è‚É£ <strong>Take Exam</strong> - Complete your monitored exam</div>
        </div>
        <div class="cta">
          <button class="btn" id="start-btn">Get Started</button>
          <button class="btn ghost" id="learn-more" style="margin-left:10px">Try as Guest</button>
        </div>
      </section>
    </main>

    
    <section id="auth" class="page card">
      <h3 style="margin-bottom:12px">Register / Login</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <h4>New user ‚Äî Register</h4>
          <form id="register-form">
            <label>Full name<input id="reg-name" required minlength="3" placeholder="Alice Example"/></label>
            <label>Email<input id="reg-email" type="email" required placeholder="you@school.edu"/></label>
            <label>Password<input id="reg-pass" type="password" required minlength="8" placeholder="At least 8 chars"/></label>
            <label>Enrollment No.<input id="reg-enroll" required placeholder="e.g. ENR2025001"/></label>
            <div class="row">
              <button class="btn" type="button" id="btn-register">Register</button>
              <div class="muted" style="align-self:center">We will ask for face registration after signing up</div>
            </div>
            <div id="reg-feedback" class="feedback"></div>
          </form>
        </div>

        <div>
          <h4>Returning user ‚Äî Login</h4>
          <form id="login-form">
            <label>Email<input id="login-email" type="email" required placeholder="you@school.edu"/></label>
            <label>Password<input id="login-pass" type="password" required/></label>
            <div class="row">
              <button class="btn" type="button" id="btn-login">Login</button>
              <button class="btn ghost" id="btn-guest" type="button">Guest</button>
            </div>
            <div id="login-feedback" class="feedback"></div>
          </form>
        </div>
      </div>
    </section>

    
    <section id="face" class="page card">
      <h3>Face Registration</h3>
      <p class="muted">Allow camera access, position your face inside the frame and capture a clear face image. Enter your enrollment number below and submit.</p>
      <div class="webcam-wrap">
        <video id="preview" autoplay playsinline></video>
        <div class="controls">
          <label>Enrollment No.<input id="face-enroll" placeholder="ENR2025001" /></label>
          <button class="btn" id="capture-btn">Capture Photo</button>
          <button class="btn ghost" id="upload-face-btn">Upload & Register Face</button>
          <div id="face-feedback" class="feedback"></div>
        </div>
      </div>
      <canvas id="capture"></canvas>
    </section>

    
    <section id="exam" class="page card">
      <div class="exam-top">
        <div>
          <div class="muted">Exam: Theory ‚Äî Handwritten Test</div>
          <div style="font-size:16px;font-weight:700">10 Questions ‚Äî Total 60 marks</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div id="timer" class="timer">03:00:00</div>
          <div id="exam-status" class="status-pill status-green">Connected</div>
        </div>
      </div>

      <div style="display:flex;gap:18px;margin-top:12px">
        <div style="flex:1">
          <div class="question-area" id="question-area"></div>
          <div class="qnav" id="qnav"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="prev-q">Previous</button>
            <button class="btn" id="next-q">Next</button>
            <button class="btn" id="submit-exam">Submit Exam</button>
          </div>
        </div>
        <div style="width:280px">
          <div class="card" style="padding:12px">
            <div class="muted">Instructions</div>
            <ul style="margin-top:8px;line-height:1.6;color:#bcd6f5">
              <li>Keep both hands visible on desk</li>
              <li>Look straight at camera</li>
              <li>No phones, laptops, or devices</li>
              <li>Face must be clearly visible</li>
              <li>Audio alerts will notify violations</li>
            </ul>
            <div style="margin-top:12px">
              <label style="display:flex;align-items:center;gap:8px;font-size:12px">
                <input type="checkbox" id="soundToggle" checked>
                <span>Sound Alerts</span>
              </label>
            </div>
            <div style="margin-top:12px">
              <div class="muted">Live Camera</div>
              <div class="camera-mini"><video id="mini-cam" autoplay playsinline style="width:100%;height:100%;object-fit:cover"></video></div>
            </div>
          </div>
        </div>
      </div>

      <div class="warnings" id="warnings"></div>
    </section>

  </div>

  
  <div class="floating-camera" id="floatingCamera">
    <video id="float-cam" autoplay playsinline style="width:100%;height:100%;object-fit:cover"></video>
  </div>

  <script>
    
    const pages = {welcome:document.getElementById('welcome'), auth:document.getElementById('auth'), face:document.getElementById('face'), exam:document.getElementById('exam')}
    let currentUser = null
    let userHasFace = false
    
    function show(page){
      // Check flow restrictions
      if(page === 'face' && !currentUser) {
        alert('Please login first before registering your face')
        return show('auth')
      }
      if(page === 'exam' && (!currentUser || !userHasFace)) {
        alert('Please complete registration and face setup before taking exam')
        return show('auth')
      }
      
      for(const p in pages){pages[p].classList.remove('active')}
      pages[page].classList.add('active')
      
      // Auto-fill enrollment if going to face registration
      if(page === 'face' && currentUser) {
        document.getElementById('face-enroll').value = currentUser.enrollment
      }
      
      // Start exam functionality when accessing exam page
      if(page === 'exam') {
        remaining = TOTAL_TIME
        startTimer()
        startDetectionLoop()
      }
      
      // Update navigation based on state
      updateNavigation()
    }
    
    function updateNavigation(){
      const nav = document.querySelector('nav')
      if(!currentUser) {
        nav.innerHTML = `
          <a href="#" onclick="show('welcome')">Welcome</a>
          <a href="#" onclick="show('auth')">Login/Register</a>
        `
      } else if(!userHasFace) {
        nav.innerHTML = `
          <a href="#" onclick="logout()">Logout (${currentUser.name})</a>
          <a href="#" onclick="show('face')">Register Face</a>
        `
      } else {
        nav.innerHTML = `
          <a href="#" onclick="logout()">Logout (${currentUser.name})</a>
          <a href="#" onclick="show('face')">Update Face</a>
          <a href="#" onclick="show('exam')">Take Exam</a>
        `
      }
    }
    
    function logout(){
      currentUser = null
      userHasFace = false
      show('welcome')
      document.getElementById('login-feedback').textContent = 'Logged out successfully'
    }
    
    document.getElementById('start-btn').onclick = ()=>show('auth')
    document.getElementById('learn-more').onclick = ()=>{
      currentUser = {id: 'guest', name: 'Guest User', enrollment: 'GUEST001'}
      userHasFace = true
      updateNavigation()
      show('exam')
    }
    
    // Initialize navigation
    updateNavigation()

    
    const API_BASE = 'http://localhost:8002' 

    document.getElementById('btn-register').addEventListener('click', async ()=>{
      const name = document.getElementById('reg-name').value.trim()
      const email = document.getElementById('reg-email').value.trim()
      const pass = document.getElementById('reg-pass').value
      const enroll = document.getElementById('reg-enroll').value.trim()
      const fb = document.getElementById('reg-feedback')
      fb.className='feedback'
      if(name.length<3){fb.textContent='Name too short';fb.classList.add('error');return}
      if(!email.includes('@')){fb.textContent='Invalid email';fb.classList.add('error');return}
      if(pass.length<8){fb.textContent='Password must be >=8 chars';fb.classList.add('error');return}
      if(!enroll){fb.textContent='Enrollment number is required';fb.classList.add('error');return}
      fb.textContent='Registering...'
      try{
        const res = await fetch(API_BASE+'/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password:pass,enroll})})
        if(res.ok){
          const data = await res.json()
          fb.textContent='Registration successful! Please login to continue.';fb.classList.add('ok')
          // Clear registration form
          document.getElementById('reg-name').value = ''
          document.getElementById('reg-email').value = ''
          document.getElementById('reg-pass').value = ''
          document.getElementById('reg-enroll').value = ''
          // Auto-fill login form
          document.getElementById('login-email').value = email
          document.getElementById('login-feedback').textContent = 'Now please login with your credentials'
        }
        else{const txt=await res.text();fb.textContent='Error: '+txt;fb.classList.add('error')}
      }catch(e){fb.textContent='Cannot reach backend: '+e.message;fb.classList.add('error')}
    })

    document.getElementById('btn-login').addEventListener('click', async ()=>{
      const email = document.getElementById('login-email').value.trim()
      const pass = document.getElementById('login-pass').value
      const fb = document.getElementById('login-feedback');fb.className='feedback'
      if(!email || !pass){fb.textContent='Provide email and password';fb.classList.add('error');return}
      fb.textContent='Logging in...'
      try{
        const res = await fetch(API_BASE+'/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pass})})
        if(res.ok){
          const data = await res.json()
          currentUser = data.user
          fb.textContent='Login successful! Welcome ' + currentUser.name;fb.classList.add('ok')
          
          // Check if user has face registered
          const faceRes = await fetch(API_BASE+'/api/check_face?enroll=' + currentUser.enrollment)
          if(faceRes.ok) {
            const faceData = await faceRes.json()
            userHasFace = faceData.hasFace
            
            if(userHasFace) {
              fb.textContent += ' - Face verified. You can take the exam.'
              setTimeout(()=>show('exam'), 1000)
            } else {
              fb.textContent += ' - Please register your face first.'
              setTimeout(()=>show('face'), 1000)
            }
          } else {
            // Assume no face if check fails
            setTimeout(()=>show('face'), 1000)
          }
        }
        else{const txt=await res.text();fb.textContent='Error: '+txt;fb.classList.add('error')}
      }catch(e){fb.textContent='Cannot reach backend: '+e.message;fb.classList.add('error')}
    })

    document.getElementById('btn-guest').addEventListener('click', ()=>{
      currentUser = {id: 'guest', name: 'Guest User', enrollment: 'GUEST001'}
      userHasFace = true // Skip face registration for guest
      const fb = document.getElementById('login-feedback')
      fb.textContent='Logged in as Guest - You can take the exam directly'
      fb.className='feedback ok'
      updateNavigation()
      setTimeout(()=>show('exam'), 1000)
    })

    
    const preview = document.getElementById('preview');
    const floatCam = document.getElementById('float-cam');
    const miniCam = document.getElementById('mini-cam');
    let mediaStream = null
    async function startCamera(){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:false})
        preview.srcObject = mediaStream
        floatCam.srcObject = mediaStream
        miniCam.srcObject = mediaStream
      }catch(e){console.error('Camera error',e);document.getElementById('face-feedback').textContent='Camera access denied or not available'}
    }
    startCamera()

    document.getElementById('capture-btn').addEventListener('click', ()=>{
      const canvas = document.getElementById('capture')
      const v = preview
      canvas.width = v.videoWidth || 640
      canvas.height = v.videoHeight || 480
      const ctx = canvas.getContext('2d')
      ctx.drawImage(v,0,0,canvas.width,canvas.height)
      const dataURL = canvas.toDataURL('image/jpeg',0.92)
      document.getElementById('face-feedback').textContent = 'Captured ‚Äî preview stored in memory. Click Upload to register face.'
      canvas.style.display='none'
      canvas.dataset.latest = dataURL
    })

    document.getElementById('upload-face-btn').addEventListener('click', async ()=>{
      const enroll = document.getElementById('face-enroll').value.trim()
      const canvas = document.getElementById('capture')
      const fb = document.getElementById('face-feedback');fb.className='feedback'
      if(!enroll){fb.textContent='Enter enrollment number';fb.classList.add('error');return}
      const dataURL = canvas.dataset.latest
      if(!dataURL){fb.textContent='No capture available ‚Äî click Capture Photo first';fb.classList.add('error');return}
      fb.textContent='Uploading face...'
      try{
        const blob = await (await fetch(dataURL)).blob()
        const form = new FormData();form.append('enroll',enroll);form.append('image',blob,'face.jpg')
        const res = await fetch(API_BASE+'/api/register_face',{method:'POST',body:form})
        if(res.ok){
          fb.textContent='Face registered successfully! You can now take the exam.';fb.classList.add('ok')
          userHasFace = true
          updateNavigation()
          setTimeout(()=>show('exam'), 1500)
        }
        else{const t=await res.text();fb.textContent='Error: '+t;fb.classList.add('error')}
      }catch(e){fb.textContent='Upload failed: '+e.message;fb.classList.add('error')}
    })

    
    const TOTAL_TIME = 3*60*60 
    let remaining = TOTAL_TIME
    let timerInterval = null
    const timerEl = document.getElementById('timer')

    
    const QUESTIONS = Array.from({length:10}).map((_,i)=>({id:i+1,text:`Question ${i+1}: Explain concept ${i+1} (6 marks).`,answer:''}))
    const qarea = document.getElementById('question-area')
    const qnav = document.getElementById('qnav')
    let currentQ = 0

    function renderQuestions(){
      qarea.innerHTML=''
      const q = QUESTIONS[currentQ]
      const card = document.createElement('div');card.className='qcard'
      card.innerHTML = `<div style="font-weight:700">Q${q.id} ‚Äî (6 marks)</div><p style="margin-top:8px">${q.text}</p><textarea id="ans-${q.id}" rows="6" style="width:100%;margin-top:8px">${q.answer}</textarea>`
      qarea.appendChild(card)
      qnav.innerHTML=''
      QUESTIONS.forEach((qq,idx)=>{const b=document.createElement('button');b.textContent=qq.id; b.onclick=()=>{currentQ=idx;renderQuestions()}; if(idx===currentQ) b.style.opacity=1; qnav.appendChild(b)})
    }
    renderQuestions()

    document.getElementById('next-q').addEventListener('click',()=>{saveCurrent(); if(currentQ<QUESTIONS.length-1) currentQ++; renderQuestions()})
    document.getElementById('prev-q').addEventListener('click',()=>{saveCurrent(); if(currentQ>0) currentQ--; renderQuestions()})
    document.getElementById('submit-exam').addEventListener('click',()=>{saveCurrent(); submitExam()})

    function saveCurrent(){
      const q = QUESTIONS[currentQ]
      const v = document.getElementById('ans-'+q.id)
      if(v) q.answer = v.value
    }

    function startTimer(){
      if(timerInterval) clearInterval(timerInterval)
      // Update timer display immediately
      timerEl.textContent = new Date(remaining*1000).toISOString().substr(11,8)
      
      timerInterval = setInterval(()=>{
        remaining--
        if(remaining<=0){clearInterval(timerInterval);autoSubmitTimeUp();return}
        if(remaining<=30) showWarning('Less than 30 seconds remaining ‚Äî exam will auto-submit', 'red')
        if(remaining<=60) document.getElementById('exam-status').textContent='Time low'
        timerEl.textContent = new Date(remaining*1000).toISOString().substr(11,8)
        
        if(remaining===5*60) showWarning('5 minutes remaining', 'red')
       
      },1000)
    }

    function autoSubmitTimeUp(){
      showWarning('Time is up ‚Äî auto-submitting exam', 'red')
      submitExam(true)
    }

    function submitExam(isAuto=false){
      
      saveCurrent()
      const payload = {answers:QUESTIONS.map(q=>({id:q.id,answer:q.answer})),auto:isAuto}
      fetch(API_BASE+'/api/submit_exam',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
      .then(r=>{if(r.ok){alert('Exam submitted'); show('welcome')}else alert('Submission failed')})
    }



    

    const warningsBox = document.getElementById('warnings')
    let detectInterval = null
    let alertHistory = {
      noFace: 0,
      wrongDirection: 0, 
      missingHands: 0,
      gadgets: 0
    }
    
    // Sound alert system
    function playAlertSound(type = 'warning') {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)()
        const oscillator = audioContext.createOscillator()
        const gainNode = audioContext.createGain()
        
        oscillator.connect(gainNode)
        gainNode.connect(audioContext.destination)
        
        if(type === 'warning') {
          // Warning sound: 800Hz for 0.3 seconds
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime)
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime)
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3)
          oscillator.start(audioContext.currentTime)
          oscillator.stop(audioContext.currentTime + 0.3)
        } else if(type === 'critical') {
          // Critical sound: 1000Hz beep pattern
          oscillator.frequency.setValueAtTime(1000, audioContext.currentTime)
          gainNode.gain.setValueAtTime(0.5, audioContext.currentTime)
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5)
          oscillator.start(audioContext.currentTime)
          oscillator.stop(audioContext.currentTime + 0.5)
        }
      } catch(e) {
        console.log('Audio not supported:', e)
      }
    }
    
    function showWarning(text, severity='red'){
      const div = document.createElement('div');div.className='warn '+(severity==='green'?'green':'red')
      div.innerHTML = `<div class="title">${text}</div>`
      warningsBox.prepend(div)
      setTimeout(()=>{div.remove()},12000)
      
      // Play sound for warnings (not for positive feedback)
      const soundEnabled = document.getElementById('soundToggle')?.checked !== false
      if(severity === 'red' && soundEnabled) {
        if(text.includes('HANDS') || text.includes('FACE') || text.includes('HEAD')) {
          playAlertSound('warning')
        } else if(text.includes('PROHIBITED') || text.includes('DEVICE') || text.includes('SECURITY')) {
          playAlertSound('critical')
        }
      }
    }

    async function sendFrameForDetection(){
      if(!mediaStream) return
      try{
        
        const v = preview
        const c = document.createElement('canvas'); c.width=320; c.height=240
        const ctx = c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height)
        const blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.7))
        const form = new FormData(); form.append('frame',blob,'frame.jpg')
        
        const res = await fetch(API_BASE+'/api/detect',{method:'POST',body:form})
        if(!res.ok) {console.warn('detect failed',res.status);document.getElementById('exam-status').textContent='Disconnected';return}
        const data = await res.json()
        
        // Process warnings from backend and track persistent issues
        if(data.warnings && data.warnings.length) {
          data.warnings.forEach(w=>{
            showWarning(w,'red')
            
            // Track persistent violations for escalating alerts
            if(w.includes('FACE NOT VISIBLE')) {
              alertHistory.noFace++
              if(alertHistory.noFace === 3) {
                showWarning('üö® CRITICAL: Face must be visible for exam validity!', 'red')
                playAlertSound('critical')
              }
            } else if(w.includes('HEAD TURNED')) {
              alertHistory.wrongDirection++
              if(alertHistory.wrongDirection === 3) {
                showWarning('üö® WARNING: Keep looking at camera - multiple violations detected', 'red')
              }
            } else if(w.includes('HANDS')) {
              alertHistory.missingHands++
              if(alertHistory.missingHands === 3) {
                showWarning('üö® ALERT: Both hands must remain visible on desk', 'red')
              }
            } else if(w.includes('PROHIBITED DEVICE')) {
              alertHistory.gadgets++
              showWarning('üö®üö® SECURITY BREACH: Unauthorized device detected! üö®üö®', 'red')
              playAlertSound('critical')
            }
          })
        } else {
          // Reset counters when no violations
          alertHistory = {noFace: 0, wrongDirection: 0, missingHands: 0, gadgets: 0}
        }
        
        const status = document.getElementById('exam-status')
        
        // Update floating camera visual state
        const floatingCam = document.getElementById('floatingCamera')
        
        // Update status based on detection results
        if(data.head_status === 'Looking Forward' && data.hand_count === 2 && (!data.gadgets || data.gadgets.length===0)){
          status.className='status-pill status-green'
          status.textContent='‚úÖ All Good ‚Äî Monitoring Active'
          floatingCam.className='floating-camera good'
          
          // Only show positive feedback occasionally to avoid spam
          if(Math.random() < 0.1) { // 10% chance
            showWarning('‚úÖ Perfect positioning - Continue with your exam', 'green')
          }
        } else {
          status.className='status-pill status-red'
          
          // Create detailed status message
          let statusMsg = []
          if(data.head_status === 'No Face Detected') {
            statusMsg.push('‚ùå Face Missing')
          } else if(data.head_status !== 'Looking Forward') {
            statusMsg.push(`‚ö†Ô∏è ${data.head_status}`)
          }
          
          if(data.hand_count < 2) {
            statusMsg.push(`‚úã Hands: ${data.hand_count}/2`)
          }
          
          if(data.gadgets && data.gadgets.length > 0) {
            statusMsg.push(`üì± ${data.gadgets.length} Device(s)`)
          }
          
          status.textContent = statusMsg.length > 0 ? statusMsg.join(' ‚Ä¢ ') : '‚ö†Ô∏è Issues Detected'
          
          // Set floating camera alert level
          if(data.gadgets && data.gadgets.length > 0) {
            floatingCam.className='floating-camera alert' // Red for devices
          } else if(data.head_status === 'No Face Detected') {
            floatingCam.className='floating-camera alert' // Red for no face
          } else {
            floatingCam.className='floating-camera warning' // Orange for other issues
          }
        }
      }catch(e){console.error('detect error',e)}
    }

    function startDetectionLoop(){
      if(detectInterval) clearInterval(detectInterval)
      detectInterval = setInterval(()=>sendFrameForDetection(),2000) // every 2s for better responsiveness
    }
   


   
    window.addEventListener('beforeunload', (e)=>{
      if(document.getElementById('exam').classList.contains('active')){
        e.preventDefault();e.returnValue='Are you sure? Your exam may not be submitted.'
      }
    })

    
    startCamera()

    

  </script>
</body>
</html>
